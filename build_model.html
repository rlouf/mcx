
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Build models in MCX &#8212; mcx  documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="MCX: XLA-rated Bayesian inference" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="build-models-in-mcx">
<h1>Build models in MCX<a class="headerlink" href="#build-models-in-mcx" title="Permalink to this headline">¶</a></h1>
<section id="syntax">
<h2>Syntax<a class="headerlink" href="#syntax" title="Permalink to this headline">¶</a></h2>
<p>MCX models are <em>generative functions</em>. Which means that called with a random
number generator key (rng key) and its arguments it will return a value. This
value will be different each time the function is called with a different rng
key.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mcx</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">coin_toss</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">&lt;~</span> <span class="n">Beta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">head</span> <span class="o">&lt;~</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">head</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key_1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2019</span><span class="p">)</span>
<span class="gp">... </span><span class="n">coin_toss</span><span class="p">(</span><span class="n">key_1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">key_2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">2020</span><span class="p">)</span>
<span class="gp">... </span><span class="n">coin_toss</span><span class="p">(</span><span class="n">key_2</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="go">0</span>
</pre></div>
</div>
<p>At the same time, generative functions represent a multivariate distribution
over the random variables included in the model. Which means you can condition
the value of its random variables, compute forward samples from the
distribution, or compute samples from the posterior distribution of the
conditioned distribution.</p>
<p>As you can see above, MCX models look pretty much like any Python function.
With two important particularities:</p>
<ol class="arabic simple">
<li><p>To signal that a function is a model it must be preceded with the
<cite>&#64;mcx.model</cite> decorator. Otherwise Python will interpret it as a regular
function.</p></li>
<li><p>MCX uses the symbol <cite>&lt;~</cite> for random variable assignments and <cite>=</cite> for
deterministic assignments. As a result models are visually very similar
to their mathematical counterpart.</p></li>
</ol>
<p>To illustrate this, let us model the number of successes in <cite>N</cite> tosses of a
coin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mcx</span>
<span class="kn">from</span> <span class="nn">mcx.distributions</span> <span class="kn">import</span> <span class="n">Beta</span><span class="p">,</span> <span class="n">Binomial</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">coin_toss</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">&lt;~</span> <span class="n">Beta</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.5</span><span class="p">)</span>
    <span class="n">successes</span> <span class="o">&lt;~</span> <span class="n">Binomial</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">successes</span>
</pre></div>
</div>
<p>As we said, generative models behave like functions:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">coin_toss</span><span class="p">(</span><span class="n">key_1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coin_toss</span><span class="p">(</span><span class="n">key_2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">7</span>
</pre></div>
</div>
<p>Since the parameters are random variables, each call will return a different
value. If you want to generate a large number of values, you can simply iterate:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">coin_toss</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
</pre></div>
</div>
<section id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Permalink to this headline">¶</a></h3>
<p>The MCX language is still young and comes with a few caveats, things that you
cannot do when expressing a model. As time passes, code is written and PRs are
merged these constraints will be relaxed and you will be able to written MCX
code like you would regular python code.</p>
<p>First, random variables and returned variables must be given a name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">random_argument_not_assigned</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Normal(0, 1) must have an explicit name.&quot;&quot;&quot;</span>
    <span class="n">b</span> <span class="o">&lt;~</span> <span class="n">Gamma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">b</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">return_value_not_assigned</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The returned variable must have a name.&quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">&lt;~</span> <span class="n">Gamma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
</pre></div>
</div>
<p>The last condition will be relaxed soon. Control flow is also not supported for
the moment, due to its use of JAX’s jit-compilation (the documentation explains
why). MCX will not compile functions such as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">if_else</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">&lt;~</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mf">.3</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">b</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">for_loop</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">&lt;~</span> <span class="n">Poisson</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">&lt;~</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>Instead you can use JAX’s <cite>lax.cond</cite>, <cite>lax.switch</cite>, <cite>lax.scan</cite> and
<cite>lax.fori_loop</cite> constructs for now.</p>
</section>
</section>
<section id="call-functions-from-a-model">
<h2>Call functions from a model<a class="headerlink" href="#call-functions-from-a-model" title="Permalink to this headline">¶</a></h2>
<p>You can call other (deterministic) python functions inside a generative model
as long as they only use python operators or functions implemented in
<a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.html">JAX</a> (most of numpy’s and some of
scipy’s methods).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mcx</span>
<span class="kn">from</span> <span class="nn">mcx.distributions</span> <span class="kn">import</span> <span class="n">Exponential</span><span class="p">,</span> <span class="n">Normal</span>

<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">one_dimensional_linear_regression</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
      <span class="n">sigma</span> <span class="o">&lt;~</span> <span class="n">Exponential</span><span class="p">(</span><span class="mf">.3</span><span class="p">)</span>
      <span class="n">mu</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
      <span class="n">y</span> <span class="o">=</span> <span class="n">multiply</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">Normal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="models-are-multivariate-distributions">
<h2>Models are (multivariate) distributions<a class="headerlink" href="#models-are-multivariate-distributions" title="Permalink to this headline">¶</a></h2>
<p>Most distributions can be seen as the result of a generative process. For
instance you can re-implement the exponential distribution in MCX as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">mcx</span>
<span class="kn">from</span> <span class="nn">mcx.distributions</span> <span class="kn">import</span> <span class="n">Exponential</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">Exponential</span><span class="p">(</span><span class="n">lmbda</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">&lt;~</span> <span class="n">Uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="o">/</span> <span class="n">lmbda</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
<p>When we say that we “sample” from the exponential distribution, we are actually
interested in the value of <cite>t</cite>, discarding the values taken by <cite>u</cite>.</p>
<p>By analogy, a generative model expressed with MCX can also be used as a
distribution, which is the distribution of the returned value. It is thus
possible to compose MCX models as follows</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mcx</span>
<span class="kn">from</span> <span class="nn">mcx.distributions</span> <span class="kn">import</span> <span class="n">HalfCauchy</span><span class="p">,</span> <span class="n">Normal</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">HorseShoe</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">scale</span> <span class="o">&lt;~</span> <span class="n">HalfCauchy</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">noise</span>
    <span class="k">return</span> <span class="n">h</span>

<span class="nd">@mcx</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">one_dimensional_linear_regression</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">sigma</span> <span class="o">&lt;~</span> <span class="n">Exponential</span><span class="p">(</span><span class="mf">.3</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">&lt;~</span> <span class="n">HorseShoe</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">mu</span>
    <span class="n">y</span> <span class="o">&lt;~</span> <span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
<p>Which encourages code re-use and modularity.</p>
</section>
<section id="querying-debugging-the-model">
<h2>Querying / Debugging the model<a class="headerlink" href="#querying-debugging-the-model" title="Permalink to this headline">¶</a></h2>
<p>MCX translates model definitions in an intermediate representation (a graph)
which can be dynamically queried and modified at runtime. Three features of MCX
make debugging a model easier: forward sampling, conditioning and the ability to
modify the model dynamically.</p>
<p>Forward sampling means sampling from the prior distribution of each variable in
the model. We sample for one data point at a time or the whole dataset in one
go.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">mcx</span>

<span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mcx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Sometimes we want to set the value of a variable in the model to a constant. We
can do so using the <cite>do</cite> operator which can be combined with the <cite>sample_forward</cite>
function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">mcx</span>

<span class="n">rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">model_c</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="n">rv</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">mcx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">model_c</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">mcx</a></h1>



<p class="blurb">MCX (pronounced /miks'/) is a python probabilistic programming library based on source code transformation.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=rlouf&repo=mcx&type=star&count=False&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build models in MCX</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">MCX: XLA-rated Bayesian inference</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Rémi Louf.
      
      |
      <a href="_sources/build_model.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/rlouf/mcx" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>